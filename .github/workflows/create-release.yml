name: Create Resource Pack Release

on:
  push:
    branches: [ main, dev ]
  workflow_dispatch: 

permissions:
  contents: write
  actions: read

jobs:
  create-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Configure Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
    
    - name: Set release variables
      run: |
        if [ "${{ github.ref_name }}" = "main" ]; then
          echo "RELEASE_TAG=release" >> $GITHUB_ENV
          echo "RELEASE_NAME=Latest Resource Pack Release" >> $GITHUB_ENV
          echo "RELEASE_FILE=release.zip" >> $GITHUB_ENV
          echo "IS_PRERELEASE=false" >> $GITHUB_ENV
        else
          echo "RELEASE_TAG=dev-release" >> $GITHUB_ENV
          echo "RELEASE_NAME=Latest Dev Resource Pack Release" >> $GITHUB_ENV
          echo "RELEASE_FILE=dev-release.zip" >> $GITHUB_ENV
          echo "IS_PRERELEASE=true" >> $GITHUB_ENV
        fi
    
    - name: Create Resource Pack Archive
      uses: thedoctor0/zip-release@0.7.5
      with:
        type: 'zip'
        filename: '${{ env.RELEASE_FILE }}'
        exclusions: |
          *.git*
          *.github*
          *node_modules*
          *.editorconfig
          *.gitignore
          *.md
          README*
          LICENSE*
          .DS_Store
          Thumbs.db
    
    - name: Verify archive contents and generate hash
      run: |
        echo "Archive created successfully!"
        ls -la ${{ env.RELEASE_FILE }}
        echo "Archive contents (first 20 entries):"
        unzip -l ${{ env.RELEASE_FILE }} | head -20
        echo ""
        echo "Generating hashes..."
        echo "SHA256: $(sha256sum ${{ env.RELEASE_FILE }} | cut -d' ' -f1)"
        echo "SHA1: $(sha1sum ${{ env.RELEASE_FILE }} | cut -d' ' -f1)"
        echo "MD5: $(md5sum ${{ env.RELEASE_FILE }} | cut -d' ' -f1)"
        
        # Save hashes to environment for use in release notes
        echo "PACK_SHA256=$(sha256sum ${{ env.RELEASE_FILE }} | cut -d' ' -f1)" >> $GITHUB_ENV
        echo "PACK_SHA1=$(sha1sum ${{ env.RELEASE_FILE }} | cut -d' ' -f1)" >> $GITHUB_ENV
        echo "PACK_MD5=$(md5sum ${{ env.RELEASE_FILE }} | cut -d' ' -f1)" >> $GITHUB_ENV
        echo "PACK_SIZE=$(stat -f%z ${{ env.RELEASE_FILE }} 2>/dev/null || stat -c%s ${{ env.RELEASE_FILE }})" >> $GITHUB_ENV
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ env.RELEASE_TAG }}
        name: ${{ env.RELEASE_NAME }}
        body: |
          üéÆ **Cobblemon Rivals Resource Pack**
          
          Automatically generated resource pack for Minecraft servers.
          
          ## üì• Usage
          - **Download:** Click `${{ env.RELEASE_FILE }}` below to download manually
          - **ForcePacks URL:** `https://github.com/${{ github.repository }}/releases/download/${{ env.RELEASE_TAG }}/${{ env.RELEASE_FILE }}`
          - **Direct integration:** Use the URL above in your server's ForcePacks plugin configuration
          
          ## üîê File Verification
          **File Size:** ${{ env.PACK_SIZE }} bytes
          **SHA256:** `${{ env.PACK_SHA256 }}`
          **SHA1:** `${{ env.PACK_SHA1 }}`
          **MD5:** `${{ env.PACK_MD5 }}`
          
          ## üìä Build Information
          **Generated:** ${{ github.event.head_commit.timestamp }}
          **Workflow Run:** ${{ github.run_id }}
          **Commit:** [`${{ github.sha }}`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          **Branch:** ${{ github.ref_name }}
        files: |
          ${{ env.RELEASE_FILE }}
        prerelease: ${{ env.IS_PRERELEASE }}
        make_latest: true
        generate_release_notes: false
        fail_on_unmatched_files: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}